<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>학교 생태지도 — 공동편집 (최종버전)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAswUcFMIVPFt788AcVWbq-dEdkDqZtnKw",
      authDomain: "dnfl-ad972.firebaseapp.com",
      projectId: "dnfl-ad972",
      storageBucket: "dnfl-ad972.appspot.com",
      messagingSenderId: "548990645593",
      appId: "1:548990645593:web:7478899875a9d106c4c848",
      measurementId: "G-XW14X9HSQE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.__fire = { db, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp };
  </script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; }
    header {
      height:56px; display:flex; align-items:center; justify-content:space-between;
      padding:8px 12px; background:#0b132b; color:#e5e7eb; box-sizing:border-box; gap:10px;
    }
    header input { height:36px; padding:0 10px; border-radius:10px; border:1px solid #334155;
      background:#0f172a; color:#e5e7eb; }
    header button { height:36px; padding:0 12px; border-radius:10px;
      border:1px solid #334155; background:#2563eb; color:white; cursor:pointer; }
    header .ghost { background:#0f172a; color:#e5e7eb; }

    #map { width: 100%; height: calc(100% - 56px); background:#f3f4f6; }

    .legend {
      position:absolute; right:10px; bottom:10px; z-index:1000;
      background:#0b132b; color:#e5e7eb; border:1px solid #1f2937;
      border-radius:10px; padding:8px 10px; font-size:13px;
      box-shadow:0 4px 14px rgba(0,0,0,.2);
    }
    .legend .row { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .legend .dot { width:12px; height:12px; border-radius:50%; display:inline-block; }
    .dot-producer { background:#22c55e; }
    .dot-consumer { background:#f59e0b; }
    .dot-decomposer { background:#ef4444; }

    #infoBanner {
      position:absolute; top:66px; left:50%; transform:translateX(-50%);
      background:#fde68a; color:#1f2937; padding:6px 12px; border-radius:10px;
      z-index:1000; display:none; font-size:13px; border:1px solid #f59e0b;
    }

    .popup-input, .popup-textarea, select {
      width:100%; margin:6px 0; padding:6px 8px; border-radius:8px;
      border:1px solid #cbd5e1; box-sizing:border-box;
    }
    .popup-textarea { height:72px; }
    .popup-btn {
      padding:6px 10px; margin:6px 4px 0 0; border-radius:8px;
      border:1px solid #94a3b8; background:#0ea5e9; color:#fff; cursor:pointer;
    }
    .popup-btn.secondary { background:#f3f4f6; color:#111827; }
    .popup-btn.danger { background:#fee2e2; border-color:#fecaca; color:#991b1b; }

  </style>
</head>
<body>
  <header>
    <div>
      <strong>학교 생태지도 · 공동편집</strong>
      <input id="roomInput" placeholder="지도 코드 (예: bio3-1)" />
      <button id="joinBtn" class="ghost">접속/변경</button>
    </div>
    <div>
      현재 방: <span id="roomLabel" style="font-weight:700;">-</span>
      <button id="exportBtn" style="margin-left:8px; background:#16a34a;">JSON 저장</button>
    </div>
  </header>

  <div id="map"></div>
  <div id="infoBanner">배경 사진(school.png)을 같은 폴더에 넣어 주세요.</div>

  <div class="legend">
    <div style="font-weight:700;">범례</div>
    <div class="row"><span class="dot dot-producer"></span>생산자</div>
    <div class="row"><span class="dot dot-consumer"></span>소비자</div>
    <div class="row"><span class="dot dot-decomposer"></span>분해자</div>
  </div>

  <script type="module">
    const { db, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp } = window.__fire;
    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -1, maxZoom: 3 });

    const imageUrl = 'school.png';
    const banner = document.getElementById('infoBanner');
    const img = new Image();
    img.onload = () => {
      const bounds = [[0,0],[img.naturalHeight,img.naturalWidth]];
      L.imageOverlay(imageUrl, bounds).addTo(map);
      map.fitBounds(bounds);
    };
    img.onerror = () => {
      banner.style.display = 'block';
      const bounds = [[0,0],[1000,2000]];
      map.fitBounds(bounds);
    };
    img.src = imageUrl;

    function makeIcon(color){
      const svg = encodeURIComponent(
        `<svg xmlns='http://www.w3.org/2000/svg' width='28' height='42' viewBox='0 0 28 42'>
           <path fill='${color}' d='M14 0C6 0 0 6 0 14c0 10 12 27 13 28a1 1 0 0 0 2 0c1-1 13-18 13-28C28 6 22 0 14 0z'/>
           <circle cx='14' cy='14' r='6' fill='white'/>
         </svg>`);
      return L.icon({ iconUrl:`data:image/svg+xml,${svg}`, iconSize:[28,42], iconAnchor:[14,42], popupAnchor:[0,-38] });
    }
    const ICONS = { producer: makeIcon('#22c55e'), consumer: makeIcon('#f59e0b'), decomposer: makeIcon('#ef4444') };

    let roomId = localStorage.getItem('eco_room') || 'bio3-1';
    const roomInput = document.getElementById('roomInput');
    const roomLabel = document.getElementById('roomLabel');
    roomInput.value = roomId; roomLabel.textContent = roomId;

    const markers = new Map();
    const dataMap = new Map();
    let unsubscribe = null;

    function bindMarker(m){ 
      m.on('click',()=>openView(m,m.__data));
      m.on('contextmenu',async()=>{
        if(confirm('이 지점을 삭제할까요?')){
          await deleteDoc(doc(db,'maps',roomId,'points',m.__data.id));
        }
      });
    }

    function subscribe(room){
      if(unsubscribe){unsubscribe(); markers.forEach(m=>map.removeLayer(m)); markers.clear(); dataMap.clear();}
      const q = query(collection(db,'maps',room,'points'));
      unsubscribe = onSnapshot(q, snap=>{
        const seen = new Set();
        snap.forEach(dSnap=>{
          const d={ id:dSnap.id, ...dSnap.data() };
          seen.add(d.id);
          dataMap.set(d.id,d);
          const icon = ICONS[d.role]||ICONS.producer;
          if(!markers.has(d.id)){
            const m = L.marker(d.latlng,{icon}).addTo(map);
            m.__data=d; markers.set(d.id,m); bindMarker(m);
          }else{
            const m=markers.get(d.id); m.__data=d; m.setLatLng(d.latlng); m.setIcon(icon);
          }
        });
        Array.from(markers.keys()).forEach(id=>{
          if(!seen.has(id)){ map.removeLayer(markers.get(id)); markers.delete(id); dataMap.delete(id); }
        });
      });
    }

    function openView(marker,d){
      const el=document.createElement('div');
      el.innerHTML=`
        <div style='font-weight:700;'>${d.sciName||'미기재'}</div>
        <div>역할: ${d.role}</div>
        <div>이름: ${d.student||'-'}</div>
        <div>먹이: ${d.diet||'-'}</div>
        <div>포식자: ${d.predator||'-'}</div>
        <div>특징: ${d.feature||'-'}</div>
        <button id='edit' class='popup-btn'>편집</button>
        <button id='del' class='popup-btn danger'>삭제</button>`;
      el.querySelector('#edit').onclick=()=>openEdit(marker,d,false);
      el.querySelector('#del').onclick=async()=>{
        if(confirm('삭제하시겠습니까?'))
          await deleteDoc(doc(db,'maps',roomId,'points',d.id));
      };
      marker.bindPopup(el).openPopup();
    }

    function openEdit(marker,d,isNew){
      const el=document.createElement('div');
      el.innerHTML=`
        <select id='role' class='popup-input'>
          <option value='producer' ${d.role==='producer'?'selected':''}>생산자</option>
          <option value='consumer' ${d.role==='consumer'?'selected':''}>소비자</option>
          <option value='decomposer' ${d.role==='decomposer'?'selected':''}>분해자</option>
        </select>
        <input id='stu' class='popup-input' placeholder='학번과 이름' value='${d.student||''}'/>
        <input id='sci' class='popup-input' placeholder='생물이름(학명)' value='${d.sciName||''}'/>
        <input id='diet' class='popup-input' placeholder='먹이' value='${d.diet||''}'/>
        <input id='pred' class='popup-input' placeholder='포식자' value='${d.predator||''}'/>
        <textarea id='feat' class='popup-textarea' placeholder='특징'>${d.feature||''}</textarea>
        <button id='save' class='popup-btn'>저장</button>
        <button id='cancel' class='popup-btn secondary'>취소</button>`;
      
      const saveBtn = el.querySelector('#save');
      saveBtn.onclick = async ()=>{
        saveBtn.disabled = true;
        saveBtn.textContent = '저장 중...';
        try{
          const ll = marker.getLatLng();
          const payload={
            role:el.querySelector('#role').value,
            student:el.querySelector('#stu').value.trim(),
            sciName:el.querySelector('#sci').value.trim(),
            diet:el.querySelector('#diet').value.trim(),
            predator:el.querySelector('#pred').value.trim(),
            feature:el.querySelector('#feat').value.trim(),
            latlng:{lat:ll.lat,lng:ll.lng},
            updatedAt:serverTimestamp()
          };
          if(isNew){
            await addDoc(collection(db,'maps',roomId,'points'),payload);
            alert('✅ 새 지점 저장 성공');
            map.removeLayer(marker);
          }else{
            await setDoc(doc(db,'maps',roomId,'points',d.id),payload,{merge:true});
            alert('✅ 수정 저장 성공');
          }
        }catch(e){
          alert('❌ 저장 실패: '+e.message);
          console.error(e);
        }finally{
          saveBtn.disabled=false;
          saveBtn.textContent='저장';
        }
      };
      el.querySelector('#cancel').onclick=()=>{ if(isNew) map.removeLayer(marker); else openView(marker,d); };
      marker.bindPopup(el).openPopup();
    }

    map.on('click', e=>{
      const temp={role:'producer',student:'',sciName:'',diet:'',predator:'',feature:'',latlng:{lat:e.latlng.lat,lng:e.latlng.lng}};
      const m=L.marker(e.latlng,{icon:ICONS.producer}).addTo(map);
      m.__data={id:'temp',...temp}; bindMarker(m); openEdit(m,temp,true);
    });

    document.getElementById('joinBtn').onclick=()=>{
      roomId=(roomInput.value||'').trim()||'bio3-1';
      localStorage.setItem('eco_room',roomId);
      roomLabel.textContent=roomId;
      subscribe(roomId);
    };

    document.getElementById('exportBtn').onclick=()=>{
      const data=Array.from(dataMap.values());
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`생태지도_${roomId}.json`;
      a.click();
    };

    subscribe(roomId);
  </script>
</body>
</html>
