<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í•™êµ ìƒíƒœì§€ë„ â€” ê³µë™í¸ì§‘ v2</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Firebase ì—°ê²° -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, doc, addDoc, setDoc, deleteDoc,
      onSnapshot, query, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAswUcFMIVPFt788AcVWbq-dEdkDqZtnKw",
      authDomain: "dnfl-ad972.firebaseapp.com",
      projectId: "dnfl-ad972",
      storageBucket: "dnfl-ad972.firebasestorage.app",
      messagingSenderId: "548990645593",
      appId: "1:548990645593:web:7478899875a9d106c4c848",
      measurementId: "G-XW14X9HSQE"
    };

    // Firebaseê°€ ì°¨ë‹¨ë˜ì—ˆê±°ë‚˜ ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œë¥¼ ëŒ€ë¹„í•œ ì•ˆì „ ì¥ì¹˜
    try {
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      window.__fire = { db, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp };
      window.dispatchEvent(new Event("__fire_ready"));
    } catch (e) {
      console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
      window.__fire_error = e;
      window.dispatchEvent(new Event("__fire_error"));
    }
  </script>
  <style>
    html, body { height: 100%; margin: 0; }
    header { height:56px; display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:#0b132b; color:#e5e7eb; box-sizing:border-box; gap:10px; font-family:system-ui, sans-serif; }
    header .left { display:flex; align-items:center; gap:8px; }
    header input { height:36px; padding:0 10px; border-radius:10px; border:1px solid #334155; background:#0f172a; color:#e5e7eb; }
    header button { height:36px; padding:0 12px; border-radius:10px; border:1px solid #334155; background:#2563eb; color:white; cursor:pointer; }
    header .ghost { background:#0f172a; color:#e5e7eb; }

    #map { width: 100%; height: calc(100% - 56px); background:#f3f4f6; }

    #searchPanel { position:absolute; top:66px; left:10px; width:292px; background:rgba(15,23,42,.96); color:#f1f5f9; padding:12px; border-radius:12px; z-index:1000; font-family:system-ui,sans-serif; font-size:14px; box-shadow:0 4px 16px rgba(0,0,0,.35); }
    #searchPanel label { display:block; margin-top:6px; color:#cbd5e1; font-size:13px; }
    #searchPanel input, #searchPanel select { width:100%; margin-top:4px; padding:6px 8px; border-radius:8px; border:1px solid #334155; background:#1e293b; color:#f1f5f9; box-sizing:border-box; }
    #searchPanel .row { display:flex; gap:8px; margin-top:8px; }
    #searchPanel button { flex:1; background:#2563eb; border:none; border-radius:8px; padding:6px 10px; color:white; cursor:pointer; }
    #searchPanel button.ghost { background:#0f172a; border:1px solid #334155; color:#e5e7eb; }

    .legend { position:absolute; right:10px; bottom:10px; z-index:1000; background:#0b132b; color:#e5e7eb; border:1px solid #1f2937; border-radius:10px; padding:8px 10px; font-family:system-ui,sans-serif; font-size:13px; box-shadow:0 4px 14px rgba(0,0,0,.2); }
    .legend .row { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .legend .dot { width:12px; height:12px; border-radius:999px; display:inline-block; border:1px solid rgba(0,0,0,.25);} 
    .dot-producer { background:#22c55e; }
    .dot-consumer { background:#f59e0b; }
    .dot-decomposer { background:#ef4444; }

    .leaflet-popup-content { font-family: system-ui, sans-serif; font-size:14px; }
    .popup-input, select { width: 100%; margin: 6px 0; padding: 6px 8px; box-sizing: border-box; border:1px solid #cbd5e1; border-radius:8px; }
    .popup-textarea { width: 100%; height: 72px; box-sizing: border-box; border:1px solid #cbd5e1; border-radius:8px; padding:6px 8px; }
    .popup-btn { padding: 6px 10px; margin: 6px 4px 0 0; border-radius:8px; border:1px solid #94a3b8; background:#0ea5e9; color:#fff; cursor:pointer; }
    .popup-btn.secondary { background:#f3f4f6; color:#111827; }
    .popup-btn.danger { background:#fee2e2; border-color:#fecaca; color:#991b1b; }

    #infoBanner { position:absolute; top:66px; left:50%; transform:translateX(-50%); background:#fde68a; color:#1f2937; padding:6px 12px; border-radius:10px; z-index:1000; display:none; font-family:system-ui,sans-serif; font-size:13px; border:1px solid #f59e0b; }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <strong>í•™êµ ìƒíƒœì§€ë„ Â· ê³µë™í¸ì§‘ v2</strong>
      <input id="roomInput" placeholder="ì§€ë„ ì½”ë“œ (ì˜ˆ: bio3-1)" />
      <button id="joinBtn" class="ghost">ì ‘ì†/ë³€ê²½</button>
    </div>
    <div class="right">
      í˜„ì¬ ë°©: <span id="roomLabel" style="font-weight:700;">-</span>
      <button id="importBtn" class="ghost" style="margin-left:8px;">JSON ê°€ì ¸ì˜¤ê¸°</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button id="exportBtn" style="margin-left:8px; background:#16a34a; border:1px solid #14532d;">í˜„ì¬ ë°ì´í„° ì €ì¥(JSON)</button>
    </div>
  </header>

  <div id="searchPanel">
    <div style="font-weight:700; margin-bottom:6px;">ğŸ” ê²€ìƒ‰Â·í•„í„°</div>
    <label>ì—­í• </label>
    <select id="roleFilter">
      <option value="">ì „ì²´</option>
      <option value="producer">ìƒì‚°ì</option>
      <option value="consumer">ì†Œë¹„ì</option>
      <option value="decomposer">ë¶„í•´ì</option>
    </select>
    <label>í•™ìƒ ì´ë¦„</label>
    <input id="studentFilter" placeholder="ì˜ˆ: í™ê¸¸ë™" />
    <label>ìƒë¬¼ì´ë¦„(í•™ëª…)</label>
    <input id="sciNameFilter" placeholder="ì˜ˆ: Pinus" />
    <div class="row">
      <button id="applyFilter">ì ìš©</button>
      <button id="clearFilter" class="ghost">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div id="map"></div>
  <div id="infoBanner">ë°°ê²½ ì‚¬ì§„(school.png)ì„ ê°™ì€ í´ë”ì— ë„£ì–´ ì£¼ì„¸ìš”.</div>
  <div class="legend" id="legend">
    <div style="font-weight:700; margin-bottom:4px;">ë²”ë¡€</div>
    <div class="row"><span class="dot dot-producer"></span><span>ìƒì‚°ì</span></div>
    <div class="row"><span class="dot dot-consumer"></span><span>ì†Œë¹„ì</span></div>
    <div class="row"><span class="dot dot-decomposer"></span><span>ë¶„í•´ì</span></div>
  </div>

  <script type="module">
    // Firebase ì¤€ë¹„ ëŒ€ê¸°: ì¼ë¶€ ë¸Œë¼ìš°ì €/ë„¤íŠ¸ì›Œí¬ì—ì„œ ëª¨ë“ˆ ë¡œë”© ì§€ì—°ë˜ëŠ” ë¬¸ì œ ëŒ€ë¹„
    await new Promise((resolve, reject) => {
      if (window.__fire) return resolve();
      const onReady = () => { window.removeEventListener("__fire_ready", onReady); resolve(); };
      const onError = () => { window.removeEventListener("__fire_error", onError); reject(window.__fire_error || new Error("Firebase not ready")); };
      window.addEventListener("__fire_ready", onReady, { once: true });
      window.addEventListener("__fire_error", onError, { once: true });
      // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
      setTimeout(() => resolve(), 5000);
    });

    if (!window.__fire) {
      const b = document.getElementById('infoBanner');
      b.style.display = 'block';
      b.textContent = 'âš ï¸ Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬/ì°¨ë‹¨ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
    }

    const { db, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp } = window.__fire || {};

    // === ì§€ë„ ===
    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -1, maxZoom: 3 });

    // ëª¨ë°”ì¼(ì•„ì´íŒ¨ë“œ)ì—ì„œ íŒì—…/ë²„íŠ¼ í´ë¦­ ëˆ„ë½ ë°©ì§€: ë§µ í´ë¦­ê³¼ ì œìŠ¤ì²˜ ë¶„ë¦¬
    map.on('popupopen', (e) => {
      if (!e.popup || !e.popup._content) return;
      const el = e.popup._content;
      L.DomEvent.disableClickPropagation(el);
      L.DomEvent.disableScrollPropagation(el);
      el.addEventListener('touchstart', (ev) => ev.stopPropagation(), { passive: true });
      el.addEventListener('pointerdown', (ev) => ev.stopPropagation());
    });

    // ë°°ê²½ ì´ë¯¸ì§€ ìë™ ë¡œë“œ (íŒŒì¼ì´ ì—†ìœ¼ë©´ ë°°ë„ˆ í‘œì‹œ)
    const imageUrl = 'school.png';
    function setBanner(show, msg){ const b=document.getElementById('infoBanner'); if(!b) return; b.style.display=show?'block':'none'; if(msg) b.textContent=msg; }
    (function loadBackground(){
      const img = new Image();
      img.onload = ()=>{ const w=img.naturalWidth||2000, h=img.naturalHeight||1000; const bounds=[[0,0],[h,w]]; L.imageOverlay(imageUrl, bounds).addTo(map); map.fitBounds(bounds); setBanner(false); };
      img.onerror = ()=>{ setBanner(true, 'ë°°ê²½ ì‚¬ì§„(school.png)ì„ ê°™ì€ í´ë”ì— ë„£ì–´ ì£¼ì„¸ìš”.'); const bounds=[[0,0],[1000,2000]]; map.fitBounds(bounds); };
      img.src = imageUrl;
    })();

    function makeIcon(color){ const svg=encodeURIComponent(`<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='28' height='42' viewBox='0 0 28 42'><path fill='${color}' d='M14 0C6.27 0 0 6.27 0 14c0 9.8 12.6 26.7 13.14 27.4a1 1 0 0 0 1.72 0C15.4 40.7 28 23.8 28 14 28 6.27 21.73 0 14 0z'/><circle cx='14' cy='14' r='6' fill='white'/></svg>`); return L.icon({iconUrl:`data:image/svg+xml,${svg}`,iconSize:[28,42],iconAnchor:[14,42],popupAnchor:[0,-38]}); }
    const ICONS = { producer: makeIcon('#22c55e'), consumer: makeIcon('#f59e0b'), decomposer: makeIcon('#ef4444') };

    // === ë°© ê´€ë¦¬ ===
    let roomId = (localStorage.getItem('eco_room') || 'bio3-1');
    const roomInput = document.getElementById('roomInput');
    const roomLabel = document.getElementById('roomLabel');
    roomInput.value = roomId; roomLabel.textContent = roomId;

    const markers = new Map();
    const dataMap = new Map();
    let unsubscribe = null;

    function bindMarkerEvents(marker){
      marker.on('click', ()=> openView(marker, marker.__data));
      // ë¡±í”„ë ˆìŠ¤(ëª¨ë°”ì¼)ë¡œë„ ì‚­ì œ ë©”ë‰´ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ contextmenu + long-press ëŒ€ì‘
      marker.on('contextmenu', tryDeleteCurrent);
      marker.on('mousedown', (e)=>{
        marker.__pressTimer = setTimeout(()=> tryDeleteCurrent(), 800);
      });
      marker.on('mouseup', ()=> clearTimeout(marker.__pressTimer));
      marker.on('mouseout', ()=> clearTimeout(marker.__pressTimer));

      async function tryDeleteCurrent(){
        try{ if(confirm('ì´ ì§€ì ì„ ì‚­ì œí• ê¹Œìš”?')) await deleteDoc(doc(db,'maps',roomId,'points',marker.__data.id)); }
        catch(e){ alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message); console.error(e); }
      }
    }

    function subscribe(room){
      if (!db) return; // Firebase ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
      if (unsubscribe) { unsubscribe(); markers.forEach(m=>map.removeLayer(m)); markers.clear(); dataMap.clear(); }
      const colRef = collection(db,'maps',room,'points');
      unsubscribe = onSnapshot(query(colRef), (snap)=>{
        const seen = new Set();
        snap.forEach(dSnap=>{ const d={ id:dSnap.id, ...dSnap.data() }; seen.add(d.id); dataMap.set(d.id,d);
          const icon=ICONS[d.role]||ICONS.producer;
          if(!markers.has(d.id)){
            // Firestore latlngëŠ” {lat, lng} ê°ì²´ë¡œ ì €ì¥ë¨
            const m=L.marker(d.latlng,{icon, keyboard:true, riseOnHover:true}).addTo(map);
            m.__data=d; markers.set(d.id,m); bindMarkerEvents(m);
          } else {
            const m=markers.get(d.id); m.__data=d; m.setLatLng(d.latlng); m.setIcon(icon);
          }
        });
        Array.from(markers.keys()).forEach(id=>{ if(!seen.has(id)){ map.removeLayer(markers.get(id)); markers.delete(id); dataMap.delete(id);} });
        applyFilters();
      }, (err)=>{ setBanner(true, 'Firestore ì—°ê²° ì˜¤ë¥˜: '+err.message); console.error(err); });
    }

    function roleToText(r){ return r==='producer'?'ìƒì‚°ì':r==='consumer'?'ì†Œë¹„ì':r==='decomposer'?'ë¶„í•´ì':'-'; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function escapeAttr(s){ return String(s||'').replace(/\"/g,'&quot;'); }

    function openView(marker, data){
      const el = document.createElement('div');
      el.innerHTML = `
        <div style='font-size:16px; font-weight:700; margin-bottom:6px;'>${escapeHtml(data.sciName||'ë¯¸ê¸°ì¬')}</div>
        <div class='kv'><b>ì—­í• </b> ${escapeHtml(roleToText(data.role))}</div>
        <div class='kv'><b>í•™ë²ˆÂ·ì´ë¦„</b> ${escapeHtml(data.student||'-')}</div>
        <div class='kv'><b>ìƒë¬¼ì´ë¦„(í•™ëª…)</b> ${escapeHtml(data.sciName||'-')}</div>
        <div class='kv'><b>ë¨¹ì´</b> ${escapeHtml(data.diet||'-')}</div>
        <div class='kv'><b>í¬ì‹ì</b> ${escapeHtml(data.predator||'-')}</div>
        <div class='kv'><b>íŠ¹ì§•</b> ${escapeHtml(data.feature||'-')}</div>
        <div style='margin-top:8px; display:flex; gap:6px;flex-wrap:wrap;'>
          <button id='edit' type='button' class='popup-btn'>í¸ì§‘</button>
          <button id='del' type='button' class='popup-btn danger'>ì‚­ì œ</button>
        </div>`;
      const onEdit = ()=> openEdit(marker, data, false);
      const onDel = async ()=>{ try{ if(confirm('ì´ ì§€ì ì„ ì‚­ì œí• ê¹Œìš”?')) await deleteDoc(doc(db,'maps',roomId,'points',data.id)); }catch(e){ alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message); console.error(e);} };
      el.addEventListener('click', (ev)=>ev.stopPropagation());
      el.querySelector('#edit').addEventListener('click', (ev)=>{ ev.preventDefault(); ev.stopPropagation(); onEdit(); });
      el.querySelector('#del').addEventListener('click', (ev)=>{ ev.preventDefault(); ev.stopPropagation(); onDel(); });
      L.DomEvent.disableClickPropagation(el);
      L.DomEvent.disableScrollPropagation(el);
      marker.bindPopup(el,{autoClose:false}).openPopup();
    }

    function openEdit(marker, data, isNew){
      const el = document.createElement('div');
      el.innerHTML = `
        <select id='role' class='popup-input'>
          <option value='producer' ${data.role==='producer'?'selected':''}>ìƒì‚°ì</option>
          <option value='consumer' ${data.role==='consumer'?'selected':''}>ì†Œë¹„ì</option>
          <option value='decomposer' ${data.role==='decomposer'?'selected':''}>ë¶„í•´ì</option>
        </select>
        <input id='f_student' class='popup-input' placeholder='í•™ë²ˆê³¼ ì´ë¦„' value='${escapeAttr(data.student||'')}' />
        <input id='f_science' class='popup-input' placeholder='ìƒë¬¼ì´ë¦„(í•™ëª…)' value='${escapeAttr(data.sciName||'')}' />
        <input id='f_diet' class='popup-input' placeholder='ë¨¹ì´' value='${escapeAttr(data.diet||'')}' />
        <input id='f_pred' class='popup-input' placeholder='í¬ì‹ì' value='${escapeAttr(data.predator||'')}' />
        <textarea id='f_feat' class='popup-textarea' placeholder='íŠ¹ì§•'>${escapeHtml(data.feature||'')}</textarea>
        <div style='display:flex; gap:6px; flex-wrap:wrap;'>
          <button id='save' type='button' class='popup-btn'>ì €ì¥</button>
          <button id='cancel' type='button' class='popup-btn secondary'>ì·¨ì†Œ</button>
          ${!isNew?"<button id='del' type='button' class='popup-btn danger'>ì‚­ì œ</button>":''}
        </div>`;

      const doSave = async ()=>{
        // LatLng â†’ plain {lat,lng} for Firestore
        const ll = marker.getLatLng();
        const latlng = { lat: ll.lat, lng: ll.lng };
        const payload = {
          role: el.querySelector('#role').value,
          student: el.querySelector('#f_student').value.trim(),
          sciName: el.querySelector('#f_science').value.trim(),
          diet: el.querySelector('#f_diet').value.trim(),
          predator: el.querySelector('#f_pred').value.trim(),
          feature: el.querySelector('#f_feat').value.trim(),
          latlng,
          updatedAt: serverTimestamp(),
        };
        if (isNew) payload.createdAt = serverTimestamp();
        try{
          if (isNew) { 
            await addDoc(collection(db,'maps',roomId,'points'), payload); 
            map.removeLayer(marker); // ì„ì‹œ ë§ˆì»¤ ì œê±°, ì‹¤ì‹œê°„ êµ¬ë…ìœ¼ë¡œ ì§„ì§œ ë§ˆì»¤ í‘œì‹œ
          } else { 
            await setDoc(doc(db,'maps',roomId,'points',data.id), payload, { merge:true });
            // ì—­í•  ë°”ë€ ê²½ìš° ì¦‰ì‹œ ì•„ì´ì½˜ë„ ê°±ì‹ (êµ¬ë… ìˆ˜ì‹  ì „ ì‹œê°ì  í”¼ë“œë°±)
            const icon = ICONS[payload.role] || ICONS.producer;
            marker.setIcon(icon);
          }
        }catch(e){
          alert('ì €ì¥ ì‹¤íŒ¨: '+e.message+'\n(ê·œì¹™/ê¶Œí•œ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”)');
          console.error(e);
        }
      };
      const doCancel = ()=>{ if(isNew){ map.removeLayer(marker);} else { openView(marker, data);} };
      const doDel = async ()=>{ try{ if(confirm('ì´ ì§€ì ì„ ì‚­ì œí• ê¹Œìš”?')) await deleteDoc(doc(db,'maps',roomId,'points',data.id)); }catch(e){ alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message); console.error(e);} };

      el.addEventListener('click', (ev)=>ev.stopPropagation());
      el.querySelector('#save').addEventListener('click', (ev)=>{ ev.preventDefault(); ev.stopPropagation(); doSave(); });
      el.querySelector('#cancel').addEventListener('click', (ev)=>{ ev.preventDefault(); ev.stopPropagation(); doCancel(); });
      const delBtn = el.querySelector('#del');
      if (delBtn) delBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); ev.stopPropagation(); doDel(); });
      L.DomEvent.disableClickPropagation(el);
      L.DomEvent.disableScrollPropagation(el);

      marker.bindPopup(el,{autoClose:false}).openPopup();
    }

    // ì§€ë„ í´ë¦­ â†’ ìƒˆ ì  ì¶”ê°€(í¸ì§‘ íŒì—…)
    map.on('click', e=>{
      const temp={ role:'producer', student:'', sciName:'', diet:'', predator:'', feature:'', latlng:{lat:e.latlng.lat,lng:e.latlng.lng} };
      const m=L.marker(e.latlng,{icon:ICONS.producer}).addTo(map);
      m.__data={ id:'temp', ...temp }; bindMarkerEvents(m); openEdit(m, temp, true);
    });

    // ë°© ì ‘ì†/ë³€ê²½
    document.getElementById('joinBtn').onclick = ()=>{ roomId=(roomInput.value||'').trim()||'bio3-1'; localStorage.setItem('eco_room',roomId); roomLabel.textContent=roomId; subscribe(roomId); };

    // JSON ì €ì¥
    document.getElementById('exportBtn').onclick = ()=>{ const data=Array.from(dataMap.values()); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ìƒíƒœì§€ë„_${roomId}.json`; a.click(); };

    // JSON ê°€ì ¸ì˜¤ê¸°(ê°™ì€ ë°©ìœ¼ë¡œ ì—…ë¡œë“œ)
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    importBtn.onclick = ()=> importFile.click();
    importFile.onchange = async (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      try{
        const text = await file.text();
        const items = JSON.parse(text);
        if (!Array.isArray(items)) throw new Error('JSON ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.');
        const yes = confirm(`ì´ ${items.length}ê°œ í•­ëª©ì„ í˜„ì¬ ë°©(${roomId})ì— ì¶”ê°€/ê°±ì‹ í• ê¹Œìš”?`);
        if (!yes) return;
        for (const it of items){
          const payload = {
            role: it.role||'producer',
            student: it.student||'',
            sciName: it.sciName||'',
            diet: it.diet||'',
            predator: it.predator||'',
            feature: it.feature||'',
            latlng: it.latlng && typeof it.latlng.lat==='number' && typeof it.latlng.lng==='number' ? it.latlng : {lat:0,lng:0},
            updatedAt: serverTimestamp(),
          };
          // idê°€ ìˆëŠ” ê²½ìš° merge, ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
          if (it.id) await setDoc(doc(db,'maps',roomId,'points',it.id), payload, { merge:true });
          else await addDoc(collection(db,'maps',roomId,'points'), payload);
        }
        alert('ê°€ì ¸ì˜¤ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }catch(err){
        alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: '+err.message);
        console.error(err);
      } finally { importFile.value = ''; }
    };

    // ê²€ìƒ‰/í•„í„° (ëŒ€ì†Œë¬¸ì/ê³µë°± ê´€ëŒ€í•œ ë¹„êµ)
    const roleEl=document.getElementById('roleFilter'); const studentEl=document.getElementById('studentFilter'); const sciEl=document.getElementById('sciNameFilter');
    function norm(s){ return String(s||'').trim().toLowerCase(); }
    function matchesFilter(d){
      const role=roleEl.value.trim();
      const student=norm(studentEl.value); const sci=norm(sciEl.value);
      if(role && d.role!==role) return false;
      if(student && !norm(d.student).includes(student)) return false;
      if(sci && !norm(d.sciName).includes(sci)) return false;
      return true;
    }
    function applyFilters(){ markers.forEach((m,id)=>{ const dd=dataMap.get(id); if(!dd){ if(map.hasLayer(m)) map.removeLayer(m); return;} const vis=matchesFilter(dd); if(vis){ if(!map.hasLayer(m)) m.addTo(map);} else { if(map.hasLayer(m)) map.removeLayer(m);} }); }
    document.getElementById('applyFilter').onclick=applyFilters; document.getElementById('clearFilter').onclick=()=>{ roleEl.value=''; studentEl.value=''; sciEl.value=''; applyFilters(); };

    // ì´ˆê¸° êµ¬ë…
    subscribe(roomId);
  </script>
</body>
</html>
